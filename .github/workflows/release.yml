name: Release
on:
  push:
    branches:
      - main

jobs:
  release:
    runs-on: macos-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: Install Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          profile: minimal
          override: true

      - name: Install dependencies
        run: bun install

      - name: Install Tauri CLI
        run: npm install -g @tauri-apps/cli

      - name: Build the app
        run: bun run tauri build

      - name: Import GPG key
        uses: crazy-max/ghaction-import-gpg@v5
        with:
          gpg_private_key: ${{ secrets.GPG_PRIVATE_KEY }}
          passphrase: ${{ secrets.GPG_PASSPHRASE }}

      - name: Create Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ github.run_number }}
          release_name: Release ${{ github.run_number }}
          draft: false
          prerelease: false

      - name: Sign and Upload Release Asset
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          APP_NAME=$(grep -m1 'name:' src-tauri/tauri.conf.json | cut -d'"' -f4)
          DMG_PATH="src-tauri/target/release/bundle/dmg/${APP_NAME}_${{ github.run_number }}.dmg"
          gpg --armor --detach-sign "$DMG_PATH"
          gh release upload v${{ github.run_number }} "$DMG_PATH" "$DMG_PATH.asc"